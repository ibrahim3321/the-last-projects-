name: Build Images & Bump Overlays

on:
  push:
    branches: [ main, feature/ci-cd ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'aks-yaml/callmebot/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:

env:
  REGISTRY: ${{ secrets.ACR_NAME }}         # e.g., group6kubacr.azurecr.io
  BACKEND_IMG: backend
  FRONTEND_IMG: frontend
  CALLMEBOT_IMG: callmebot-adapter

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Azure Container Registry Login
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.REGISTRY }}

      # --------- Build Backend ----------
      - name: Build backend
        working-directory: backend
        run: |
          TAG=${GITHUB_SHA::7}
          docker build -t $REGISTRY/$BACKEND_IMG:$TAG -t $REGISTRY/$BACKEND_IMG:latest .
          docker push $REGISTRY/$BACKEND_IMG:$TAG
          docker push $REGISTRY/$BACKEND_IMG:latest
          echo "BACKEND_TAG=$TAG" >> $GITHUB_ENV

      # --------- Build Frontend ----------
      - name: Build frontend
        working-directory: frontend
        run: |
          TAG=${GITHUB_SHA::7}
          docker build -t $REGISTRY/$FRONTEND_IMG:$TAG -t $REGISTRY/$FRONTEND_IMG:latest .
          docker push $REGISTRY/$FRONTEND_IMG:$TAG
          docker push $REGISTRY/$FRONTEND_IMG:latest
          echo "FRONTEND_TAG=$TAG" >> $GITHUB_ENV

      # --------- Build Callmebot ----------
      - name: Build callmebot-adapter
        working-directory: aks-yaml/callmebot
        run: |
          TAG=${GITHUB_SHA::7}
          docker build -t $REGISTRY/$CALLMEBOT_IMG:$TAG -t $REGISTRY/$CALLMEBOT_IMG:latest .
          docker push $REGISTRY/$CALLMEBOT_IMG:$TAG
          docker push $REGISTRY/$CALLMEBOT_IMG:latest
          echo "CALLMEBOT_TAG=$TAG" >> $GITHUB_ENV

      # --------- Update Overlays (dev/prod) ----------
      - name: Update kustomize image tags (dev/prod)
        run: |
          update_patch () {
            ENV_DIR=$1
            FILE="aks-yaml/overlays/$ENV_DIR/patch-images.yaml"
            [ -f "$FILE" ] || { echo "Missing $FILE"; exit 1; }
            # Replace image tags for backend, frontend, callmebot
            sed -i -E "s|($REGISTRY/$BACKEND_IMG):[a-z0-9]+|\\1:${BACKEND_TAG}|g" "$FILE"
            sed -i -E "s|($REGISTRY/$FRONTEND_IMG):[a-z0-9]+|\\1:${FRONTEND_TAG}|g" "$FILE"
            sed -i -E "s|($REGISTRY/$CALLMEBOT_IMG):[a-z0-9]+|\\1:${CALLMEBOT_TAG}|g" "$FILE"
          }
          update_patch dev || true
          update_patch prod || true

      - name: Commit & push overlay changes
        if: ${{ github.ref != 'refs/heads/main' || github.ref == 'refs/heads/main' }}
        run: |
          git config user.name "ci-bot"
          git config user.email "ci-bot@users.noreply.github.com"
          git add aks-yaml/overlays/dev/patch-images.yaml || true
          git add aks-yaml/overlays/prod/patch-images.yaml || true
          git commit -m "chore: bump images to $GITHUB_SHA" || echo "No changes to commit"
          git push
