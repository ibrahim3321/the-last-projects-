apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-bootstrap
  namespace: test
spec:
  backoffLimit: 2
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: bootstrap
          image: mcr.microsoft.com/mssql-tools
          command: ["bash","-lc"]
          args:
            - |
              set -e
              # 1) Ensure DB exists
              sqlcmd -S ${DB_HOST},${DB_PORT} -U ${ADMIN_USER} -P "${ADMIN_PASS}" -C -Q "
                IF DB_ID(N'${DB_NAME}') IS NULL
                  CREATE DATABASE [${DB_NAME}];
              "
              # 2) Ensure server LOGIN exists
              sqlcmd -S ${DB_HOST},${DB_PORT} -U ${ADMIN_USER} -P "${ADMIN_PASS}" -C -Q "
                IF NOT EXISTS (SELECT 1 FROM sys.sql_logins WHERE name = N'${APP_LOGIN}')
                  CREATE LOGIN [${APP_LOGIN}] WITH PASSWORD = N'${APP_PASS}';
              "
              # 3) Ensure DB USER exists and is member of db_owner (simplest dev choice)
              sqlcmd -S ${DB_HOST},${DB_PORT} -U ${ADMIN_USER} -P "${ADMIN_PASS}" -C -d ${DB_NAME} -Q "
                IF NOT EXISTS (SELECT 1 FROM sys.database_principals WHERE name = N'${APP_LOGIN}')
                  CREATE USER [${APP_LOGIN}] FOR LOGIN [${APP_LOGIN}] WITH DEFAULT_SCHEMA = [dbo];
                IF NOT EXISTS (
                  SELECT 1 FROM sys.database_role_members rm
                  JOIN sys.database_principals r ON rm.role_principal_id = r.principal_id
                  JOIN sys.database_principals m ON rm.member_principal_id = m.principal_id
                  WHERE r.name = N'db_owner' AND m.name = N'${APP_LOGIN}'
                )
                  ALTER ROLE [db_owner] ADD MEMBER [${APP_LOGIN}];
              "
          env:
            - name: DB_HOST
              valueFrom: { configMapKeyRef: { name: backend-config, key: DB_HOST } }
            - name: DB_PORT
              valueFrom: { configMapKeyRef: { name: backend-config, key: DB_PORT } }
            - name: DB_NAME
              valueFrom: { configMapKeyRef: { name: backend-config, key: DB_NAME } }

            - name: ADMIN_USER
              valueFrom: { configMapKeyRef: { name: backend-config, key: DB_USERNAME } }  
            - name: ADMIN_PASS
              valueFrom: { secretKeyRef: { name: mssql-secret, key: SA_PASSWORD } }
               
              
            - name: APP_LOGIN
              valueFrom: { secretKeyRef: { name: appdb-secret, key: DB_USERNAME } }
            - name: APP_PASS
              valueFrom: { secretKeyRef: { name: appdb-secret, key: DB_PASSWORD } }
